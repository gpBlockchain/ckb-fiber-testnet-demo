# ckb-fiber-testnet-demo

- Compilation project
- Configure two fiber nodes
- Create a 2000CKB channel for node1 and node2
- Node 1 transfers 200CKB to node 2 via the channel
- Close Channel



###  compile project

```
git clone https://github.com/nervosnetwork/fiber.git
cd fiber
cargo build --release

# https://github.com/nervosnetwork/ckb/releases/tag/v0.117.0
wget https://github.com/nervosnetwork/ckb/releases/download/v0.117.0/ckb_v0.117.0_aarch64-apple-darwin-portable.zip

unzip ckb_v0.117.0_aarch64-apple-darwin-portable.zip
mkdir tmp 
cp target/release/fnn tmp
cp ckb_v0.117.0_aarch64-apple-darwin-portable/ckb-cli tmp
```

### Configure two fiber nodes

node1


```
cd tmp
mkdir -p testnet-fnn/node1
cp ../config/testnet/config.yml testnet-fnn/node1
./ckb-cli account new  
./ckb-cli account export  --lock-arg 0x30c54eb6b4ddb48b9335420abe0813e3e67f46e1 --extended-privkey-path exported-key
head -n 1 ./ckb/exported-key > ./ckb/key
ckb-cli util key-info  --privkey-path ./ckb/key
# https://faucet.nervos.org/

```

node2

```
cd tmp
mkdir testnet-fnn/node2
cp ../config/testnet/config.yml testnet-fnn/node2
vi testnet-fnn/node2/config.yml 
./ckb-cli account new  
./ckb-cli account export  --lock-arg 0x30c54eb6b4ddb48b9335420abe0813e3e67f46e1 --extended-privkey-path exported-key
mkdir testnet-fnn/node2/ckb
head -n 1 ./ckb/exported-key > testnet-fnn/node2/ckb/key
ckb-cli util key-info  --privkey-path testnet-fnn/node2/ckb/key
```

start nodes

```shell

RUST_LOG=info ./fnn -c testnet-fnn/node1/config.yml -d testnet-fnn/node1

RUST_LOG=info ./fnn -c testnet-fnn/node2/config.yml -d testnet-fnn/node2


```



### Create a 2000CKB channel for node1 and node2

Connect node 1 and node 2

```shell

curl --location 'http://127.0.0.1:8227' --header 'Content-Type: application/json' --data '{
    "id": 42,
    "jsonrpc": "2.0",
    "method": "connect_peer",
    "params": [
        {
            "address": "/ip4/127.0.0.1/tcp/8230/p2p/QmaQSn11jsAXWLhjHtZ9EVbauD88sCmYzty3GmYcoVWP2j"
        }
    ]
}'
```



open Channel

```shell

curl --location 'http://127.0.0.1:8227' --header 'Content-Type: application/json' --data '{
    "id": 42,
    "jsonrpc": "2.0",
    "method": "open_channel",
    "params": [
        {
            "peer_id": "QmaQSn11jsAXWLhjHtZ9EVbauD88sCmYzty3GmYcoVWP2j",
            "funding_amount": "0x2e90edd000"
        }
    ]
}'

{"jsonrpc": "2.0", "result": {"temporary_channel_id": "0xbf1b507e730b08024180ed9cb5bb3655606d3a89e94476033cf34d206d352751"}, "id": 42}

```

Call list_channels and wait until state equals CHANNEL_READY.


```shell
curl --location 'http://127.0.0.1:8227' --header 'Content-Type: application/json' --data '{
    "id": 42,
    "jsonrpc": "2.0",
    "method": "list_channels",
    "params": [
        {
            "peer_id": "QmaQSn11jsAXWLhjHtZ9EVbauD88sCmYzty3GmYcoVWP2j"
        }
    ]
}'
{"jsonrpc": "2.0", "result": {"channels": [{"channel_id": "0x2329a1ced09d0c9eff46068ac939596bb657a984b1d6385db563f2de837b8879", "peer_id": "QmaQSn11jsAXWLhjHtZ9EVbauD88sCmYzty3GmYcoVWP2j", "state": {"state_name": "NEGOTIATING_FUNDING", "state_flags": "OUR_INIT_SENT | THEIR_INIT_SENT"}, "local_balance": "0x2d1f615200", "sent_tlc_balance": "0x0", "remote_balance": "0x0", "received_tlc_balance": "0x0", "created_at": "0x620a0b7b1676b"}]}, "id": 42}

curl --location 'http://127.0.0.1:8227' --header 'Content-Type: application/json' --data '{
    "id": 42,
    "jsonrpc": "2.0",
    "method": "list_channels",
    "params": [
        {
            "peer_id": "QmaQSn11jsAXWLhjHtZ9EVbauD88sCmYzty3GmYcoVWP2j"
        }
    ]
}'
response:
{"jsonrpc": "2.0", "result": {"channels": [{"channel_id": "0x2329a1ced09d0c9eff46068ac939596bb657a984b1d6385db563f2de837b8879", "peer_id": "QmaQSn11jsAXWLhjHtZ9EVbauD88sCmYzty3GmYcoVWP2j", "state": {"state_name": "CHANNEL_READY", "state_flags": []}, "local_balance": "0x2d1f615200", "sent_tlc_balance": "0x0", "remote_balance": "0x0", "received_tlc_balance": "0x0", "created_at": "0x620a0b7b1676b"}]}, "id": 42}

```


### Node 1 transfers 200CKB to node 2 via the channel

Node 2 generates a 200 CKB invoice

```shell
curl --location 'http://127.0.0.1:8231' --header 'Content-Type: application/json' --data '{
    "id": 42,
    "jsonrpc": "2.0",
    "method": "new_invoice",
    "params": [
        {
            "amount": "0x4a817c800",
            "currency": "Fibb",
            "description": "test invoice generated by node2",
            "expiry": "0xe10",
            "final_cltv": "0x28",
            "payment_preimage": "0xab788595c4d6c2dd2e5435f39314ebd62e8df90df80e2d6c9584e88101805a5d",
            "hash_algorithm": "sha256"
        }
    ]
}'

{"jsonrpc": "2.0", "result": {"invoice_address": "fibb200000000001q5av2wkgju6gfw0pmm6vkawpjefmrngj04rzayq7n8djp0npqkuqaal03ew3mm3jnyqtlrwu0huv8zudjk09792630463vrsz78pw2230d0ww6xzlmyk2y7wyrpk2xg5em2j2jh5r9ls9qxszmlq3znvkcxkp682720ngeaydqgecjjwgs4u3h30c4z6u5rs74h8lq5cda85", "invoice": {"currency": "Fibb", "amount": "0x4a817c800", "signature": null, "data": {"timestamp": "0x1919198e9c0", "payment_hash": "0x28b329be792e00b7cd174297070d5cb1fb4068840cc72870acd3b4743afb5999", "attrs": [{"Description": "test invoice generated by node2"}, {"ExpiryTime": {"secs": 3600, "nanos": 0}}, {"FinalHtlcMinimumCltvExpiry": 40}, {"HashAlgorithm": "sha256"}]}}}, "id": 42}
```


Node 1 sends a payment

```shell

curl --location 'http://127.0.0.1:8227' --header 'Content-Type: application/json' --data '{
    "id": 42,
    "jsonrpc": "2.0",
    "method": "add_tlc",
    "params": [
        {
            "channel_id": "0x2329a1ced09d0c9eff46068ac939596bb657a984b1d6385db563f2de837b8879",
            "amount": "0x4a817c800",
            "payment_hash": "0x28b329be792e00b7cd174297070d5cb1fb4068840cc72870acd3b4743afb5999",
            "expiry": 40,
            "hash_algorithm": "sha256"
        }
    ]
}'
response:
{"jsonrpc": "2.0", "result": {"tlc_id": "0x0"}, "id": 42}
```

Node 2 provides payment_preimage

```shell
curl --location 'http://127.0.0.1:8231' --header 'Content-Type: application/json' --data '{
    "id": 42,
    "jsonrpc": "2.0",
    "method": "remove_tlc",
    "params": [
        {
            "channel_id": "0x2329a1ced09d0c9eff46068ac939596bb657a984b1d6385db563f2de837b8879",
            "tlc_id": "0x0",
            "reason": {
                "payment_preimage": "0xab788595c4d6c2dd2e5435f39314ebd62e8df90df80e2d6c9584e88101805a5d"
            }
        }
    ]
}'
```

Check balance

```shell
curl --location 'http://127.0.0.1:8227' --header 'Content-Type: application/json' --data '{
    "id": 42,
    "jsonrpc": "2.0",
    "method": "list_channels",
    "params": [
        {
            "peer_id": "QmaQSn11jsAXWLhjHtZ9EVbauD88sCmYzty3GmYcoVWP2j"
        }
    ]
}'
response:
{"jsonrpc": "2.0", "result": {"channels": [{"channel_id": "0x2329a1ced09d0c9eff46068ac939596bb657a984b1d6385db563f2de837b8879", "peer_id": "QmaQSn11jsAXWLhjHtZ9EVbauD88sCmYzty3GmYcoVWP2j", "state": {"state_name": "CHANNEL_READY", "state_flags": []}, "local_balance": "0x2877498a00", "sent_tlc_balance": "0x0", "remote_balance": "0x4a817c800", "received_tlc_balance": "0x0", "created_at": "0x620a0b7b1676b"}]}, "id": 42}
```
- remote_balance: 0x4a817c800 = 200*100000000
- local_balance: 0x2877498a00 = 1738*100000000


### close channel

```shell
curl --location 'http://127.0.0.1:8227' --header 'Content-Type: application/json' --data '{
    "id": 42,
    "jsonrpc": "2.0",
    "method": "shutdown_channel",
    "params": [
        {
            "channel_id": "0x2329a1ced09d0c9eff46068ac939596bb657a984b1d6385db563f2de837b8879",
            "close_script": {
                "code_hash": "0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8",
                "hash_type": "type",
                "args": "0xe266ef916081dbf19e13f1a485bbbc2206a01dc1"
            },
            "fee_rate": "0x3FC"
        }
    ]
}'
response:
{"jsonrpc": "2.0", "result": null, "id": 42}
```



check channel 

```
curl --location 'http://127.0.0.1:8227' --header 'Content-Type: application/json' --data '{
    "id": 42,
    "jsonrpc": "2.0",
    "method": "list_channels",
    "params": [
        {
            "peer_id": "QmaQSn11jsAXWLhjHtZ9EVbauD88sCmYzty3GmYcoVWP2j"
        }
    ]
}'
response:
{"jsonrpc": "2.0", "result": {"channels": []}, "id": 42}
```


